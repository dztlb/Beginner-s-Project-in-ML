# 模型文件(.pkl)使用指南

## 概述

`.pkl` 文件是 Python 的 pickle 格式文件，用于保存和加载 Python 对象。在机器学习项目中，通常用来保存训练好的模型，以便后续使用而无需重新训练。

## 打开 .pkl 文件的方法

### 方法一：使用 pickle 模块（基础方法）

```python
import pickle

# 加载模型
def load_model(model_path):
    """
    加载.pkl模型文件
    
    参数:
        model_path (str): 模型文件路径
    
    返回:
        加载的模型对象
    """
    try:
        with open(model_path, 'rb') as file:
            model = pickle.load(file)
        print(f"模型加载成功: {model_path}")
        return model
    except Exception as e:
        print(f"模型加载失败: {e}")
        return None

# 使用示例
model = load_model('models/XGB_model.pkl')
```

### 方法二：使用 joblib 模块（推荐方法）

```python
import joblib

# 加载模型
def load_model_joblib(model_path):
    """
    使用joblib加载模型（推荐方法）
    
    参数:
        model_path (str): 模型文件路径
    
    返回:
        加载的模型对象
    """
    try:
        model = joblib.load(model_path)
        print(f"模型加载成功: {model_path}")
        return model
    except Exception as e:
        print(f"模型加载失败: {e}")
        return None

# 使用示例
model = load_model_joblib('models/XGB_model.pkl')
```

### 方法三：检查模型文件内容

```python
import pickle
import joblib

def inspect_model_file(model_path):
    """
    检查模型文件的内容和类型
    
    参数:
        model_path (str): 模型文件路径
    """
    try:
        # 尝试使用pickle加载
        with open(model_path, 'rb') as file:
            model = pickle.load(file)
        
        print(f"模型类型: {type(model)}")
        print(f"模型信息: {model}")
        
        # 如果是sklearn模型，显示更多信息
        if hasattr(model, 'get_params'):
            print(f"模型参数: {model.get_params()}")
        
        return model
    except Exception as e:
        print(f"检查失败: {e}")
        return None

# 使用示例
inspect_model_file('models/RF_model.pkl')
```

## 项目中的模型文件说明

### 可用的模型文件

| 文件名 | 模型类型 | 用途 |
|--------|----------|------|
| `DT_model.pkl` | 决策树模型 | 基础分类/回归模型 |
| `RF_model.pkl` | 随机森林模型 | 集成学习模型 |
| `RF_Tuned_model.pkl` | 调优后的随机森林 | 超参数优化后的模型 |
| `Stacking_model.pkl` | Stacking融合模型 | 多模型集成 |
| `XGB_model.pkl` | XGBoost模型 | 高性能梯度提升模型 |

### 加载所有模型

```python
import os
import joblib

def load_all_models(models_dir='models'):
    """
    加载models目录下的所有模型
    
    参数:
        models_dir (str): 模型目录路径
    
    返回:
        dict: 模型名称到模型对象的映射
    """
    models = {}
    
    if not os.path.exists(models_dir):
        print(f"模型目录不存在: {models_dir}")
        return models
    
    for filename in os.listdir(models_dir):
        if filename.endswith('.pkl'):
            model_path = os.path.join(models_dir, filename)
            model_name = filename.replace('.pkl', '')
            
            try:
                model = joblib.load(model_path)
                models[model_name] = model
                print(f" 加载成功: {model_name}")
            except Exception as e:
                print(f" 加载失败: {model_name} - {e}")
    
    return models

# 使用示例
all_models = load_all_models()
print(f"成功加载 {len(all_models)} 个模型")
```

## 使用模型进行预测

### 基础预测示例

```python
import numpy as np
import pandas as pd
import joblib

def predict_with_model(model_path, input_data):
    """
    使用加载的模型进行预测
    
    参数:
        model_path (str): 模型文件路径
        input_data: 输入数据（numpy数组或pandas DataFrame）
    
    返回:
        预测结果
    """
    # 加载模型
    model = joblib.load(model_path)
    
    # 进行预测
    if hasattr(model, 'predict'):
        predictions = model.predict(input_data)
        return predictions
    else:
        print("模型不支持predict方法")
        return None

# 使用示例
# 假设有预处理后的特征数据
sample_data = np.array([[1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0]])  # 8个特征
predictions = predict_with_model('models/XGB_model.pkl', sample_data)
print(f"预测结果: {predictions}")
```

### 批量预测示例

```python
def batch_predict(model_path, data_file, output_file):
    """
    批量预测并保存结果
    
    参数:
        model_path (str): 模型文件路径
        data_file (str): 输入数据文件路径
        output_file (str): 输出结果文件路径
    """
    # 加载模型
    model = joblib.load(model_path)
    
    # 加载数据
    data = pd.read_excel(data_file)
    
    # 进行预测
    predictions = model.predict(data)
    
    # 保存结果
    results_df = pd.DataFrame({
        'prediction': predictions
    })
    results_df.to_excel(output_file, index=False)
    
    print(f"批量预测完成，结果保存到: {output_file}")

# 使用示例
# batch_predict('models/XGB_model.pkl', 'test_data.xlsx', 'predictions.xlsx')
```

## 模型信息查看

### 查看模型详细信息

```python
def analyze_model(model_path):
    """
    分析模型文件的详细信息
    
    参数:
        model_path (str): 模型文件路径
    """
    model = joblib.load(model_path)
    
    print(f"模型文件: {model_path}")
    print(f"模型类型: {type(model).__name__}")
    print(f"模型类: {type(model)}")
    
    # 显示模型属性
    print("\n模型属性:")
    for attr in dir(model):
        if not attr.startswith('_'):
            try:
                value = getattr(model, attr)
                if not callable(value):
                    print(f"  {attr}: {value}")
            except:
                pass
    
    # 如果是sklearn模型，显示参数
    if hasattr(model, 'get_params'):
        print("\n模型参数:")
        params = model.get_params()
        for key, value in params.items():
            print(f"  {key}: {value}")

# 使用示例
analyze_model('models/RF_model.pkl')
```

## 注意事项

### 1. 环境兼容性

```python
# 确保加载模型的环境与训练环境兼容
import sys
print(f"Python版本: {sys.version}")
print(f"scikit-learn版本: {sklearn.__version__}")
print(f"XGBoost版本: {xgboost.__version__}")
```

### 2. 内存管理

```python
# 对于大型模型，注意内存使用
import gc

def load_model_with_memory_management(model_path):
    """带内存管理的模型加载"""
    model = joblib.load(model_path)
    gc.collect()  # 垃圾回收
    return model
```

### 3. 错误处理

```python
def safe_load_model(model_path):
    """安全的模型加载，包含错误处理"""
    try:
        model = joblib.load(model_path)
        return model, None
    except FileNotFoundError:
        return None, "模型文件不存在"
    except Exception as e:
        return None, f"加载失败: {str(e)}"

# 使用示例
model, error = safe_load_model('models/XGB_model.pkl')
if error:
    print(f"错误: {error}")
else:
    print("模型加载成功")
```

## 实际应用示例

### 完整的预测流程

```python
import pandas as pd
import numpy as np
import joblib
from sklearn.preprocessing import StandardScaler

def complete_prediction_pipeline():
    """
    完整的预测流程示例
    """
    # 1. 加载模型
    model = joblib.load('models/XGB_model.pkl')
    
    # 2. 准备数据（示例数据）
    # 注意：实际使用时需要与训练时相同的预处理
    sample_data = pd.DataFrame({
        'r-time': [120],
        'r-temperature': [180],
        'c-time': [4],
        'c-temperature': [400],
        'Co3+': [0.1],
        'urea': [0.5],
        'NH4F': [0.2],
        'SDS': [0.1],
        'load mass-mg/cm2': [2.0],
        'Co-material_encoded': [0],
        'F-base_encoded': [0],
        'code_encoded': [0]
    })
    
    # 3. 数据预处理（如果需要）
    # 注意：这里需要与训练时相同的预处理步骤
    
    # 4. 进行预测
    prediction = model.predict(sample_data)
    
    # 5. 输出结果
    print(f"预测结果: {prediction}")
    return prediction

# 运行示例
# complete_prediction_pipeline()
```

## 故障排除

### 常见问题及解决方案

1. **版本不兼容**
```python
# 解决方案：重新训练模型或使用兼容版本
pip install scikit-learn==1.0.2
```

2. **文件损坏**
```python
# 检查文件完整性
import os
file_size = os.path.getsize('models/XGB_model.pkl')
print(f"文件大小: {file_size} bytes")
```

3. **内存不足**
```python
# 使用内存映射加载
model = joblib.load('models/XGB_model.pkl', mmap_mode='r')
```

---

## 技术支持

如果在使用过程中遇到问题，可以：

1. 检查模型文件是否存在
2. 确认Python环境和依赖包版本
3. 查看错误信息并参考上述故障排除方法
4. 参考项目文档：`项目详细说明文档.md`